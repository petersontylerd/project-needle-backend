# Data Models

This document describes the database schema and ORM models used by the Quality Compass backend.

## Overview

The backend uses SQLAlchemy 2.0 with async support. Models are defined in `src/db/models.py` and use:
- UUID primary keys generated by PostgreSQL (`gen_random_uuid()`)
- Timezone-aware timestamps
- Enum types for constrained values
- JSONB columns for flexible structured data

## Core Models

### Signal

The primary entity representing a quality signal detected by the analytics engine.

**Table:** `signals`

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| canonical_node_id | VARCHAR(255) | Reference to source node in insight graph |
| metric_id | VARCHAR(100) | Metric identifier (e.g., "losIndex") |
| domain | ENUM | Quality domain (Efficiency, Safety, Effectiveness) |
| facility | VARCHAR(255) | Facility name |
| facility_id | VARCHAR(50) | Medicare ID or facility code |
| system_name | VARCHAR(255) | Health system name |
| service_line | VARCHAR(255) | Primary service line |
| sub_service_line | VARCHAR(255) | Sub-service line (optional) |
| description | TEXT | Human-readable signal description |
| metric_value | NUMERIC(10,4) | Current metric value |
| peer_mean | NUMERIC(10,4) | Peer cohort mean (benchmark) |
| peer_std | NUMERIC(10,4) | Peer cohort standard deviation |
| percentile_rank | NUMERIC(5,2) | Position in peer distribution |
| encounters | INTEGER | Number of patient encounters |
| detected_at | TIMESTAMP | When anomaly was detected |
| created_at | TIMESTAMP | Record creation timestamp |
| updated_at | TIMESTAMP | Last modification timestamp |

**Signal Classification (9-Type System):**

| Column | Type | Description |
|--------|------|-------------|
| simplified_signal_type | VARCHAR(50) | Signal type classification |
| simplified_severity | INTEGER | Severity score 0-100 |
| simplified_severity_range | JSONB | [min, max] range for signal type |
| simplified_inputs | JSONB | 5 classification input values |
| simplified_indicators | JSONB | Categorical interpretations |
| simplified_reasoning | TEXT | Human-readable reasoning |
| simplified_severity_calculation | JSONB | Breakdown of severity calculation |

**Entity Grouping:**

| Column | Type | Description |
|--------|------|-------------|
| entity_dimensions | JSONB | Key-value pairs for entity dimensions |
| entity_dimensions_hash | VARCHAR(32) | MD5 hash for unique constraint |
| groupby_label | VARCHAR(255) | Human-readable groupby label |
| group_value | VARCHAR(500) | Entity dimension value(s) |

**Temporal Data:**

| Column | Type | Description |
|--------|------|-------------|
| temporal_node_id | VARCHAR(255) | Reference to temporal node |
| metric_trend_timeline | JSONB | Timeline for sparkline visualization |
| trend_direction | VARCHAR(20) | Direction (increasing, decreasing, stable) |
| metadata_per_period | JSONB | Per-period breakdown values |
| peer_percentile_trends | JSONB | Peer distribution at each period |

**Business Impact:**

| Column | Type | Description |
|--------|------|-------------|
| annual_excess_cost | NUMERIC(12,2) | Estimated annual excess cost |
| excess_los_days | NUMERIC(10,2) | Excess length of stay days |
| capacity_impact_bed_days | NUMERIC(10,4) | Bed day capacity impact |
| expected_metric_value | NUMERIC(10,4) | Expected value based on case mix |
| why_matters_narrative | TEXT | Business impact narrative |

**Indexes:**
- `ix_signals_domain` - Domain filter
- `ix_signals_facility` - Facility filter
- `ix_signals_system_name` - System filter
- `ix_signals_service_line` - Service line filter
- `ix_signals_detected_at` - Date sorting
- `ix_signals_metric_id` - Metric filter
- `ix_signals_entity_dimensions` - GIN index on JSONB
- `ix_signals_simplified_signal_type` - Signal type filter
- `ix_signals_simplified_severity` - Priority sorting

**Unique Constraint:**
```sql
UNIQUE(canonical_node_id, metric_id, facility_id, entity_dimensions_hash, detected_at)
```

### User

User accounts for authentication and authorization.

**Table:** `users`

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| email | VARCHAR(255) | Unique email address |
| name | VARCHAR(255) | Display name |
| hashed_password | VARCHAR(255) | bcrypt password hash |
| role | ENUM | User role for authorization |
| is_active | BOOLEAN | Soft delete flag |
| created_at | TIMESTAMP | Account creation |
| updated_at | TIMESTAMP | Last modification |

**User Roles:**
- `admin` - Full system access
- `clinical_leadership` - Clinical leadership role
- `nursing_leadership` - Nursing leadership role
- `administration` - Administrative role
- `viewer` - Read-only access

### Assignment

Signal assignment and workflow state.

**Table:** `assignments`

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| signal_id | UUID | Foreign key to signal (unique) |
| assignee_id | UUID | Foreign key to assigned user |
| assigner_id | UUID | Foreign key to assigning user |
| status | ENUM | Current workflow status |
| role_type | ENUM | Role type for assignment |
| notes | TEXT | Assignment notes |
| resolution_notes | TEXT | Resolution notes |
| assigned_at | TIMESTAMP | When assigned |
| started_at | TIMESTAMP | When work started |
| resolved_at | TIMESTAMP | When marked resolved |
| closed_at | TIMESTAMP | When closed |
| created_at | TIMESTAMP | Record creation |
| updated_at | TIMESTAMP | Last modification |

**Assignment Statuses:**
- `new` - Signal detected, not yet assigned
- `assigned` - Assigned to user, work not started
- `in_progress` - Work in progress
- `resolved` - Issue resolved by assignee
- `closed` - Verified and closed

**Status Transitions:**
```
new → assigned
assigned → in_progress, new
in_progress → resolved, assigned
resolved → closed, in_progress
closed → (terminal)
```

### ActivityEvent

Activity feed events for audit trail.

**Table:** `activity_events`

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| event_type | ENUM | Type of event |
| signal_id | UUID | Related signal (optional) |
| user_id | UUID | User who triggered (optional) |
| payload | JSONB | Event-specific data |
| read | BOOLEAN | Whether event has been read |
| created_at | TIMESTAMP | Event timestamp |

**Event Types:**
- `new_signal` - New signal detected
- `regression` - Metric regressed
- `improvement` - Metric improved
- `insight` - AI-generated insight
- `technical_error` - System error
- `assignment` - Signal assigned to user
- `status_change` - Workflow status changed
- `comment` - User comment added
- `intervention_activated` - Intervention started
- `intervention_outcome` - Intervention outcome measured

**Partial Index for Unread:**
```sql
CREATE INDEX ix_activity_events_unread
ON activity_events (read, created_at)
WHERE read = FALSE;
```

## Enumeration Types

### SignalDomain

Quality domains for signal classification:
- `Efficiency` - Operational efficiency metrics
- `Safety` - Patient safety metrics
- `Effectiveness` - Clinical effectiveness metrics

### MetricPolarity

Direction indicating clinically desirable performance:
- `lower_is_better` - Lower values indicate better performance (e.g., LOS)
- `higher_is_better` - Higher values indicate better performance
- `target_range` - Both extremes can be unfavorable

### MagnitudeTier

Severity of deviation from peer benchmarks:
- `critical` - Extreme deviation (percentile >= 99 or |z| >= 3.0)
- `severe` - Very high deviation (percentile 95-98.9)
- `elevated` - High deviation (percentile 85-94.9)
- `marginal` - Moderate deviation (percentile 75-84.9)
- `expected` - Within normal range (percentile 25-74.9)
- `favorable` - Better than expected (percentile 10-24.9)
- `excellent` - Best performers (percentile < 10)

### TrajectoryTier

Direction and speed of change over time:
- `rapidly_deteriorating` - Fast worsening (slope percentile >= 90)
- `deteriorating` - Worsening (slope percentile 70-89.9)
- `stable` - Flat trend (slope percentile 30-69.9)
- `improving` - Getting better (slope percentile 10-29.9)
- `rapidly_improving` - Fast improvement (slope percentile < 10)

### ConsistencyTier

Stability of signal pattern over time:
- `persistent` - Low variance (CV < 0.30, 6+ periods)
- `variable` - Moderate variance (CV 0.30-0.70)
- `transient` - High variance or insufficient history

## Relationships

```
User ←───────────┐
  │              │
  │ assigned_to  │ assigned_by
  │              │
  ▼              │
Assignment ──────┘
  │
  │ signal
  ▼
Signal
  │
  │ activity_events
  ▼
ActivityEvent
```

### Signal → Assignment (One-to-One)
Each signal has at most one active assignment.

### Signal → ActivityEvent (One-to-Many)
A signal can have many activity events.

### User → Assignment (One-to-Many)
A user can be assignee or assigner for many assignments.

### User → ActivityEvent (One-to-Many)
A user can trigger many activity events.

## Database Session Management

Sessions are created per-request with automatic commit/rollback:

```python
async def get_async_db_session() -> AsyncGenerator[AsyncSession, None]:
    async with async_session_maker() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise
```

Usage in routes:

```python
from src.dependencies import DbSession

@router.get("/signals")
async def list_signals(db: DbSession):
    result = await db.execute(select(Signal))
    return result.scalars().all()
```

## Migrations

Database migrations are managed by Alembic.

**Create a new migration:**
```bash
uv run alembic revision -m "description_of_change"
```

**Apply migrations:**
```bash
uv run alembic upgrade head
```

**Check current revision:**
```bash
uv run alembic current
```

Migration files are in `alembic/versions/`.
