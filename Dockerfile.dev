# Quality Compass Backend - Development Dockerfile
# Supports hot-reload via uvicorn --reload

FROM python:3.12-slim

WORKDIR /app

# Install uv for fast dependency management
RUN pip install --no-cache-dir uv

# Copy dependency files first for layer caching
COPY pyproject.toml uv.lock* README.md ./

# Create virtual environment and install dependencies including dev extras
# Dev extras needed for E2E validation tests (pytest-asyncio, httpx)
RUN uv venv /app/.venv && \
    . /app/.venv/bin/activate && \
    uv sync --frozen --no-install-project --extra dev

# Copy alembic configuration (source code is mounted at runtime)
COPY alembic.ini ./
COPY alembic/ ./alembic/

# Set environment variables
ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Expose API port
EXPOSE 8000

# Run uvicorn with reload for development hot-reload
# Source code will be mounted from host via docker-compose volume
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--reload-dir", "src"]
